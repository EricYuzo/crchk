#! /usr/bin/env sh

error() {
    echo "$PROGRAM: $@" 1>&2
    exit 1
}

check_dependencies() {
    command -v crc32 > /dev/null
    if [ $? -ne 0 ] ; then
        error "program crc32 missing."
    fi
}

extract_crc() {
    echo "$1" | grep -q '^.*\[[0-9A-Fa-f]\{8\}\].*$'
    if [ $? -eq 0 ] ; then
        echo "$1" | tr '[A-F]' '[a-f]' | sed 's/.*\[\([0-9a-f]\{8\}\)\].*/\1/'
    else
        echo "$not_found"
    fi
}

verify() {
    name=$1
    crc_name=`extract_crc $name`
    crc_calc=`crc32 $name`
    if [ "$crc_name" = "$crc_calc" ] ; then
        status="ok"
    elif [ "$crc_name" = "$not_found" ] ; then
        status="$not_found"
    else
        status="corrupted"
    fi

    echo "$name    $crc_name    $crc_calc    $status"
}

main() {
    check_dependencies

    if [ -f "$1" ] ; then
        verify $1
    fi
}

not_found='NA'
PROGRAM=$(basename $0)

main "$1"
